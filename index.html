<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Markdown IO Avanzato</title>
    <style>
        body {
            font-family: 'Titillium Web', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            color: #17324D;
        }
        #editor, #preview {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        #editor {
            background-color: #F2F7FC;
        }
        #preview {
            border-left: 1px solid #0073E6;
            background-color: #FFFFFF;
        }
        textarea {
            width: 100%;
            height: calc(100% - 40px);
            border: none;
            resize: none;
            background-color: #F2F7FC;
            color: #17324D;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 10px;
        }
        #controls {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }
        button, select {
            background-color: #0073E6;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
            font-family: 'Titillium Web', sans-serif;
        }
        button:hover, select:hover {
            background-color: #005CA8;
        }
        .io-button {
            background-color: #0073E6;
            color: white;
            padding: 10px 15px;
            text-decoration: none;
            border-radius: 4px;
            display: inline-block;
            margin-top: 10px;
        }
        #front-matter {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            background-color: #E6F0FA;
            border: 1px solid #0073E6;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="editor">
        <textarea id="front-matter" placeholder="Inserisci il front-matter YAML qui..."></textarea>
        <textarea id="markdown-input" placeholder="Inserisci il tuo Markdown qui..."></textarea>
    </div>
    <div id="preview"></div>
    <div id="controls">
        <button id="copy-btn">Copia Markdown</button>
        <button id="save-image-btn">Salva Immagine</button>
        <button id="load-btn">Carica File</button>
        <button id="save-btn">Salva File</button>
        <select id="display-select">
            <option value="mobile">Mobile</option>
            <option value="tablet">Tablet</option>
            <option value="desktop">Desktop</option>
        </select>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/2.0.3/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.5.0-beta4/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script>
        const frontMatterInput = document.getElementById('front-matter');
        const markdownInput = document.getElementById('markdown-input');
        const preview = document.getElementById('preview');
        const copyBtn = document.getElementById('copy-btn');
        const saveImageBtn = document.getElementById('save-image-btn');
        const loadBtn = document.getElementById('load-btn');
        const saveBtn = document.getElementById('save-btn');
        const displaySelect = document.getElementById('display-select');

        // Funzione per convertire Markdown in HTML
        function renderMarkdown() {
            let frontMatter = '';
            try {
                const yamlData = jsyaml.load(frontMatterInput.value);
                if (yamlData && yamlData.it) {
                    frontMatter = generateCTAButtons(yamlData.it);
                }
            } catch (e) {
                console.error('Errore nel parsing del front-matter YAML:', e);
            }
            
            const htmlContent = marked(markdownInput.value);
            preview.innerHTML = frontMatter + htmlContent;
        }

        function generateCTAButtons(data) {
            let buttons = '';
            if (data.cta_1) {
                buttons += `<a href="${data.cta_1.action}" class="io-button">${data.cta_1.text}</a>`;
            }
            if (data.cta_2) {
                buttons += `<a href="${data.cta_2.action}" class="io-button">${data.cta_2.text}</a>`;
            }
            return buttons;
        }

        // Aggiorna la preview in tempo reale
        frontMatterInput.addEventListener('input', renderMarkdown);
        markdownInput.addEventListener('input', renderMarkdown);

        // Copia il Markdown nella clipboard
        copyBtn.addEventListener('click', () => {
            const fullContent = `${frontMatterInput.value}\n---\n${markdownInput.value}`;
            navigator.clipboard.writeText(fullContent).then(() => {
                alert('Contenuto copiato nella clipboard!');
            });
        });

        // Salva la preview come immagine PNG
        saveImageBtn.addEventListener('click', () => {
            html2canvas(preview).then(canvas => {
                const link = document.createElement('a');
                link.download = 'preview.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        });

        // Carica file Markdown
        loadBtn.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.md';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    const content = event.target.result;
                    const [, frontMatter, markdown] = content.match(/^(---\n[\s\S]*?\n---\n)?([\s\S]*)$/);
                    frontMatterInput.value = frontMatter ? frontMatter.replace(/^---\n|---\n$/g, '') : '';
                    markdownInput.value = markdown.trim();
                    renderMarkdown();
                };
                reader.readAsText(file);
            };
            input.click();
        });

        // Salva file Markdown
        saveBtn.addEventListener('click', () => {
            const content = `---\n${frontMatterInput.value}\n---\n\n${markdownInput.value}`;
            const blob = new Blob([content], { type: 'text/markdown' });
            const link = document.createElement('a');
            link.download = 'document.md';
            link.href = URL.createObjectURL(blob);
            link.click();
        });

        // Cambia la visualizzazione del preview
        displaySelect.addEventListener('change', () => {
            const selectedDisplay = displaySelect.value;
            switch (selectedDisplay) {
                case 'mobile':
                    preview.style.width = '375px';
                    preview.style.margin = '0 auto';
                    break;
                case 'tablet':
                    preview.style.width = '768px';
                    preview.style.margin = '0 auto';
                    break;
                case 'desktop':
                    preview.style.width = '100%';
                    preview.style.margin = '0';
                    break;
            }
        });

        // Implementazione del parser Markdown personalizzato per IO
        marked.setOptions({
            renderer: new marked.Renderer(),
            gfm: true,
            breaks: true,
            highlight: function(code) {
                return `<pre><code>${code}</code></pre>`;
            }
        });

        // Estendi il renderer per gestire i CTA e altre funzionalitÃ  specifiche di IO
        const renderer = new marked.Renderer();

        renderer.link = (href, title, text) => {
            if (href.startsWith('iohandledlink://')) {
                return `<a href="${href}" class="io-link">${text}</a>`;
            }
            return `<a href="${href}" target="_blank">${text}</a>`;
        };

        renderer.list = (body, ordered, start) => {
            const type = ordered ? 'ol' : 'ul';
            return `<${type} style="padding-left: 20px;">${body}</${type}>`;
        };

        renderer.listitem = (text) => {
            return `<li style="margin-bottom: 5px;">${text}</li>`;
        };

        renderer.heading = (text, level) => {
            const fontSize = 24 - (level * 2);
            return `<h${level} style="font-size: ${fontSize}px; margin-top: 20px; margin-bottom: 10px;">${text}</h${level}>`;
        };

        marked.use({ renderer });

        // Funzione di validazione del Markdown
        function validateMarkdown(markdown) {
            const warnings = [];
            
            // Verifica la presenza di titoli
            if (!/^#\s.+/m.test(markdown)) {
                warnings.push("Il documento dovrebbe iniziare con un titolo di primo livello (#).");
            }

            // Verifica la lunghezza massima delle righe
            const lines = markdown.split('\n');
            lines.forEach((line, index) => {
                if (line.length > 100) {
                    warnings.push(`La riga ${index + 1} supera i 100 caratteri.`);
                }
            });

            // Verifica l'uso corretto dei link
            const linkRegex = /\[([^\]]+)\]\(([^)]+)\)/g;
            let match;
            while ((match = linkRegex.exec(markdown)) !== null) {
                const [, text, url] = match;
                if (!url.startsWith('https://') && !url.startsWith('iohandledlink://')) {
                    warnings.push(`Il link "${text}" non inizia con https:// o iohandledlink://.`);
                }
            }

            return warnings;
        }

        // Aggiungi la validazione al renderMarkdown
        function renderMarkdown() {
            const warnings = validateMarkdown(markdownInput.value);
            if (warnings.length > 0) {
                console.warn("Avvisi di validazione Markdown:", warnings);
            }
            
            // ... (resto del codice di renderMarkdown)
        }

        // Inizializza la preview
        renderMarkdown();
    </script>
</body>
</html>
